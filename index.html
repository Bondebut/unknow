<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <script src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>
    <h1>สแกนบาร์โค้ด</h1>
    <button id="openScanner">เปิดกล้องสแกน</button>

    <dialog id="scannerDialog">
        <video id="video" style="width: 100%;"></video>
        <p>ผลลัพธ์: <span id="barcodeResult">-</span></p>
        <button id="conFirm">ตกลง</button>
        <button id="closeScanner">ปิด</button>
    </dialog>

    <script>
        const openScannerBtn = document.getElementById("openScanner");
        const closeScannerBtn = document.getElementById("closeScanner");
        const confirmBtn = document.getElementById("conFirm");
        const scannerDialog = document.getElementById("scannerDialog");
        const barcodeResult = document.getElementById("barcodeResult");
        let codeReader;

        openScannerBtn.addEventListener("click", async () => {
            scannerDialog.showModal();
            startScanner();
        });

        closeScannerBtn.addEventListener("click", () => {
            scannerDialog.close();
            stopScanner();
        });

        confirmBtn.addEventListener("click", () => {
            scannerDialog.close();
            stopScanner();
            alert("ข้อมูลที่ได้: " + barcodeResult.textContent);
        });

        async function startScanner() {
            codeReader = new ZXing.BrowserMultiFormatReader();
            try {
                const videoInputDevices = await codeReader.listVideoInputDevices();
                let backCamera = videoInputDevices[0].deviceId; // กล้องหลัง (default)

                // เลือกกล้องหลัง (ถ้ามี)
                videoInputDevices.forEach((device) => {
                    if (device.label.toLowerCase().includes("back")) {
                        backCamera = device.deviceId;
                    }
                });

                codeReader.decodeFromVideoDevice(backCamera, 'video', (result, err) => {
                    if (result) {
                        barcodeResult.textContent = result.text;
                        stopScanner();
                        // ❌ ไม่ปิด Dialog อัตโนมัติ
                    }
                });
            } catch (err) {
                alert("เกิดข้อผิดพลาด: " + err);
            }
        }

        function stopScanner() {
            if (codeReader) {
                codeReader.reset();
            }
        }
    </script>
</body>
</html>
